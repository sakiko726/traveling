import streamlit as st
import requests

st.title("ğŸŒ æ—…è¡Œå…ˆãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‰ã‚¢ãƒ—ãƒª")
st.write("å¸Œæœ›ã™ã‚‹æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦ã­ï¼")

# ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›
year = st.selectbox("å‡ºç™ºã™ã‚‹å¹´", [2025, 2026])
month = st.selectbox("å‡ºç™ºã™ã‚‹æœˆ", list(range(1, 13)))
pref = st.selectbox("è¡ŒããŸã„éƒ½é“åºœçœŒï¼ˆå€™è£œï¼‰", [
    "æ±äº¬", "å¤§é˜ª", "äº¬éƒ½", "åŒ—æµ·é“", "æ²–ç¸„", "ç¦å²¡", "åºƒå³¶"
])
preferred_temp = st.slider("å¸Œæœ›ã™ã‚‹æ°—æ¸©ï¼ˆâ„ƒï¼‰", 0, 35, 20)

# APIã‚­ãƒ¼èª­ã¿è¾¼ã¿
API_KEY = st.secrets["WEATHER_API_KEY"]

# ä»®ã®ç·¯åº¦çµŒåº¦ãƒ‡ãƒ¼ã‚¿
coordinates = {
    "æ±äº¬": (35.6895, 139.6917),
    "å¤§é˜ª": (34.6937, 135.5023),
    "äº¬éƒ½": (35.0116, 135.7681),
    "åŒ—æµ·é“": (43.0642, 141.3469),
    "æ²–ç¸„": (26.2125, 127.6811),
    "ç¦å²¡": (33.5904, 130.4017),
    "åºƒå³¶": (34.3853, 132.4553)
}

lat, lon = coordinates[pref]

# API URLï¼ˆOpen-Meteo ä¾‹ï¼‰
url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&daily=temperature_2m_max&timezone=Asia%2FTokyo"

if st.button("ğŸ” ãŠã™ã™ã‚ã‚’è¦‹ã‚‹ï¼"):

    # APIã‚³ãƒ¼ãƒ«
    response = requests.get(url)

    if response.status_code == 200:
        data = response.json()
        temps = data["daily"]["temperature_2m_max"]

        # æœˆã®å¹³å‡æ°—æ¸©ï¼ˆã–ã£ãã‚Š1ãƒ¶æœˆ30æ—¥åˆ†ã¨ã—ã¦å…ˆé ­30ä»¶ï¼‰
        avg_temp = sum(temps[:30]) / len(temps[:30])

        st.write(f"ğŸ“é¸æŠåœ°ï¼š{pref}")
        st.write(f"ğŸ“Šäºˆæ¸¬å¹³å‡æ°—æ¸©ï¼š{avg_temp:.1f}â„ƒ")

        # åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆä»®ï¼‰
        diff = abs(avg_temp - preferred_temp)

        if diff <= 3:
            st.success(f"âœ¨ {pref} ã¯å¸Œæœ›ã«è¿‘ã„æ°—æ¸©ã§ãŠã™ã™ã‚ï¼")
        elif diff <= 7:
            st.info(f"â–³ {pref}ã¯å°‘ã—æ°—æ¸©ãŒé•ã†ã‹ã‚‚â€¦ã§ã‚‚ãƒ¯ãƒ³ãƒãƒ£ãƒ³ã‚ã‚Šï¼")
        else:
            st.error(f"ğŸ’¦ {pref}ã¯å¸Œæœ›æ°—æ¸©ã¨çµæ§‹é›¢ã‚Œã¦ã‚‹ã‚ˆâ€¦ä»–ã‚’æ¤œè¨ã—ã‚ˆï¼")

    else:
        st.error("APIå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸğŸ˜¢")
